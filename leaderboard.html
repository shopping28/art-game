<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .header { padding: 15px; background: #111; border-bottom: 2px solid #D4AF37; display: flex; align-items: center; justify-content: space-between; }
        .back { color: #D4AF37; text-decoration: none; font-size: 1.5rem; font-weight: bold; }
        h2 { margin: 0; color: #D4AF37; text-transform: uppercase; font-size: 1.1rem; }

        /* STATUS BADGE */
        .status-badge { text-align: center; padding: 10px; background: #222; font-size: 0.8rem; letter-spacing: 1px; }
        .live { color: #0f0; }
        .calc { color: #ffaa00; animation: blink 1s infinite; }
        .final { color: #D4AF37; font-weight: bold; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .list-container { flex: 1; overflow-y: auto; padding: 10px; }
        
        .player-row { 
            display: flex; align-items: center; background: #1a1a1a; 
            margin-bottom: 8px; padding: 10px; border-radius: 12px; 
            border: 1px solid #333; 
        }
        
        .rank-1 { border-color: #FFD700; background: linear-gradient(90deg, #222, #3a2e00); }
        .rank-2 { border-color: #C0C0C0; }
        .rank-3 { border-color: #CD7F32; }

        .rank-num { width: 30px; font-weight: bold; font-size: 1.1rem; color: #666; text-align: center; }
        .rank-1 .rank-num { color: #FFD700; }
        
        .avatar { width: 40px; height: 40px; border-radius: 50%; margin: 0 10px; object-fit: cover; }
        .info { flex: 1; }
        .name { font-weight: 600; font-size: 0.9rem; }
        .score { font-weight: bold; color: #D4AF37; }

        /* CALCULATING SCREEN */
        .calculating-screen {
            display: none; height: 100%; flex-direction: column; align-items: center; justify-content: center;
        }
        .loader { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid #D4AF37; border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="header">
        <a href="home.html" class="back">‚ùÆ</a>
        <h2>Leaderboard</h2>
        <div style="width:20px"></div>
    </div>

    <div id="statusBadge" class="status-badge live">LIVE RANKING</div>

    <!-- CALCULATING SCREEN -->
    <div id="calcScreen" class="calculating-screen">
        <div class="loader"></div>
        <h3 style="color:#D4AF37; margin-top:20px;">CALCULATING RESULTS</h3>
        <p style="color:#666">Please wait while we verify scores...</p>
    </div>

    <!-- LIST -->
    <div class="list-container" id="list">
        <div style="text-align:center; margin-top:50px; color:#666">Loading...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyDKO9G5GLdHk5D_UCzDx-A76yb80zvesJ4", authDomain: "quiz-55a8d.firebaseapp.com", databaseURL: "https://quiz-55a8d-default-rtdb.firebaseio.com", projectId: "quiz-55a8d", storageBucket: "quiz-55a8d.firebasestorage.app", messagingSenderId: "745030366382", appId: "1:745030366382:web:25d6210f97391136d5693f" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // CHECK SEASON STATUS
        get(ref(db, 'game_settings')).then(snap => {
            if(snap.exists()) {
                const s = snap.val();
                const end = new Date(`${s.endDate}T${s.endTime}:00`).getTime();
                const now = Date.now();
                const resultTime = end + (10 * 60 * 1000); // 10 Mins after end

                if (now < end) {
                    // LIVE
                    loadRanks(false);
                } else if (now >= end && now < resultTime) {
                    // CALCULATING
                    document.getElementById('statusBadge').className = "status-badge calc";
                    document.getElementById('statusBadge').innerText = "SEASON ENDED - CALCULATING...";
                    document.getElementById('list').style.display = 'none';
                    document.getElementById('calcScreen').style.display = 'flex';
                } else {
                    // FINAL RESULTS
                    document.getElementById('statusBadge').className = "status-badge final";
                    document.getElementById('statusBadge').innerText = "üèÜ OFFICIAL FINAL RESULTS üèÜ";
                    loadRanks(true);
                }
            }
        });

        function loadRanks(isFinal) {
            onValue(ref(db, 'users'), (snap) => {
                const list = document.getElementById('list');
                list.innerHTML = '';
                
                let users = [];
                snap.forEach(c => { 
                    const u = c.val();
                    if(u.status === 'active' && u.score > 0) users.push(u); 
                });
                
                users.sort((a,b) => (b.score || 0) - (a.score || 0));

                users.forEach((u, i) => {
                    const rank = i + 1;
                    const img = u.profilePic || `https://ui-avatars.com/api/?name=${u.fname}&background=1a1a1a&color=fff`;
                    
                    list.innerHTML += `
                        <div class="player-row rank-${rank}">
                            <div class="rank-num">${rank}</div>
                            <img src="${img}" class="avatar">
                            <div class="info">
                                <div class="name">${u.fname} ${u.lname}</div>
                                <div style="font-size:0.7rem; color:#666">ID: ${u.userId}</div>
                            </div>
                            <div class="score">${u.score}</div>
                        </div>
                    `;
                });
            });
        }
    </script>
</body>
</html>
