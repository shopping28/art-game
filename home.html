<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - ART QUIZ</title>
    <style>
        body { background: #050505; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 70px; }
        
        /* Header with Profile */
        .header { padding: 15px 20px; background: #111; border-bottom: 1px solid #D4AF37; display: flex; justify-content: space-between; align-items: center; }
        .logo { color: #D4AF37; font-weight: bold; font-size: 1.2rem; }
        
        .profile-chip {
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            background: #222; padding: 5px 15px 5px 5px; border-radius: 30px; border: 1px solid #333;
        }
        .p-img { width: 35px; height: 35px; border-radius: 50%; background: #D4AF37; object-fit: cover; }
        .p-name { font-size: 0.9rem; font-weight: bold; color: #eee; }

        /* Notification Toast */
        .toast {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(212, 175, 55, 0.9); color: #000; padding: 10px 20px;
            border-radius: 20px; font-weight: bold; z-index: 1000;
            display: none; animation: slideDown 0.5s; width: 80%; text-align: center;
        }
        @keyframes slideDown { from { top: -50px; } to { top: 80px; } }

        .hero { text-align: center; margin-top: 60px; }
        .start-btn { 
            background: #111; border: 2px solid #D4AF37; color: #D4AF37; 
            width: 200px; height: 200px; border-radius: 50%; font-size: 1.5rem; 
            cursor: pointer; box-shadow: 0 0 30px rgba(212, 175, 55, 0.2); transition: 0.3s;
        }
        .start-btn:active { background: #D4AF37; color: black; transform: scale(0.95); }

        .info-card { background: #1a1a1a; margin: 20px; padding: 20px; border-left: 4px solid #D4AF37; border-radius: 5px; }

        .nav { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #333; }
        .nav a { color: #777; text-decoration: none; font-size: 0.9rem; }
        .nav a.active { color: #D4AF37; }
    </style>
</head>
<body>

    <!-- Notification Toast -->
    <div id="toast" class="toast">New User Joined!</div>

    <div class="header">
        <div class="logo">ART QUIZ</div>
        <!-- Profile Clickable Area -->
        <div class="profile-chip" onclick="location.href='profile.html'">
            <img src="https://via.placeholder.com/35" id="uImg" class="p-img">
            <span class="p-name" id="uName">Loading...</span>
        </div>
    </div>

    <div class="hero">
        <button class="start-btn" onclick="startGame()">START<br>GAME</button>
        <p style="color:#888; margin-top:20px;">Tap to Enter Arena</p>
    </div>

    <div class="info-card">
        <h3>Season Status</h3>
        <p id="sName">Loading...</p>
        <p>Prize: <span id="sPrize" style="color:#D4AF37">...</span></p>
    </div>

    <div class="nav">
        <a href="#" class="active">Home</a>
        <a href="leaderboard.html">Leaderboard</a>
        <a href="login_register.html">Logout</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyDKO9G5GLdHk5D_UCzDx-A76yb80zvesJ4", authDomain: "quiz-55a8d.firebaseapp.com", databaseURL: "https://quiz-55a8d-default-rtdb.firebaseio.com", projectId: "quiz-55a8d", storageBucket: "quiz-55a8d.firebasestorage.app", messagingSenderId: "745030366382", appId: "1:745030366382:web:25d6210f97391136d5693f" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // 1. SECURITY CHECK (Redirect if not logged in)
        const localUser = JSON.parse(localStorage.getItem('artUser'));
        if(!localUser || !localUser.phone) {
            window.location.href = 'login_register.html';
        }

        // 2. Load User Data (Sync with DB)
        get(ref(db, `users/${localUser.phone}`)).then(snap => {
            if(!snap.exists() || snap.val().status !== 'active') {
                alert("Access Denied. Account not active.");
                window.location.href = 'login_register.html';
            } else {
                const u = snap.val();
                document.getElementById('uName').innerText = u.fname;
                if(u.profilePic) document.getElementById('uImg').src = u.profilePic;
                else document.getElementById('uImg').src = `https://ui-avatars.com/api/?name=${u.fname}&background=D4AF37&color=000`;
            }
        });

        // 3. Load Game Settings
        get(ref(db, 'game_settings')).then(snap => {
            if(snap.exists()) {
                document.getElementById('sName').innerText = snap.val().seasonName;
                document.getElementById('sPrize').innerText = snap.val().prize;
            }
        });

        // 4. NEW USER NOTIFICATION LISTENER
        const eventsRef = ref(db, 'global_events');
        onChildAdded(eventsRef, (data) => {
            const event = data.val();
            const now = Date.now();
            // Only show events that happened in last 10 seconds to avoid spam on load
            if (event.type === 'new_user' && (now - event.timestamp) < 10000) {
                const toast = document.getElementById('toast');
                toast.innerText = event.text;
                toast.style.display = 'block';
                setTimeout(() => { toast.style.display = 'none'; }, 7000); // 7 seconds
            }
        });

        window.startGame = () => window.location.href = 'start.html';
    </script>
</body>
</html>
